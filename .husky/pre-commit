#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Check if committing to main branch
branch=$(git rev-parse --abbrev-ref HEAD)
if [ "$branch" = "main" ]; then
  echo "‚ùå Direct commits to main branch are not allowed!"
  echo "Please create a feature branch and submit a pull request."
  exit 1
fi

# Check Prettier formatting
echo "üé® Checking code formatting with Prettier..."
npx prettier --check "**/*.{js,ts,json,md,yml,yaml}" || {
  echo "‚ùå Code formatting issues found!"
  echo "Run 'npx prettier --write .' to fix formatting"
  exit 1
}

# Check constitution finalization
echo "üìã Checking constitution finalization..."
constitution_files=$(git diff --cached --name-only | grep "\.specify/memory/constitution/.*\.md$" || true)
if [ -n "$constitution_files" ]; then
  for file in $constitution_files; do
    if [ ! -f "$file.finalized" ]; then
      echo "‚ùå Constitution file '$file' is not finalized!"
      echo "Run 'touch $file.finalized' to mark as finalized"
      exit 1
    fi
  done
fi

echo "‚úÖ All pre-commit checks passed!"