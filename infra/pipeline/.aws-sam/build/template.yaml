AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Path-aware CI for multi-stack (generic function worker + ddb layer worker)
Parameters:
  RepoName:
    Type: String
    Default: cogira-backend
  BranchName:
    Type: String
    Default: main
  ProjectPrefix:
    Type: String
    Default: cogira
  CiEnv:
    Type: String
    Default: dev
    Description: ENV passed to root Makefile (loads env/<ENV>.env)
Mappings:
  Images:
    Standard:
      Image: aws/codebuild/standard:7.0
Resources:
  RepoArn:
    Type: AWS::SSM::Parameter
    Properties:
      Name:
        Fn::Sub: /${ProjectPrefix}/ci/repo-arn/${RepoName}
      Type: String
      Value:
        Fn::Sub: arn:${AWS::Partition}:codecommit:${AWS::Region}:${AWS::AccountId}:${RepoName}
      Description: Stored for reference only.
  EventsToCodeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName:
        Fn::Sub: ${ProjectPrefix}-ci-events-startbuild
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: events.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: StartDispatcher
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action: codebuild:StartBuild
            Resource:
              Fn::GetAtt:
              - CiDispatchProject
              - Arn
  CiDispatchRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName:
        Fn::Sub: ${ProjectPrefix}-ci-dispatch-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: codebuild.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: Logs
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource: '*'
      - PolicyName: DiffAndTrigger
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - codecommit:GetDifferences
            - codecommit:GetCommit
            - codecommit:GetRepository
            - codecommit:GetPullRequest
            - codecommit:GitPull
            Resource:
              Fn::Sub: arn:${AWS::Partition}:codecommit:${AWS::Region}:${AWS::AccountId}:${RepoName}
          - Effect: Allow
            Action: codebuild:StartBuild
            Resource:
            - Fn::GetAtt:
              - CiDdbLayerProject
              - Arn
            - Fn::GetAtt:
              - CiFunctionWorkerProject
              - Arn
  CiWorkerRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName:
        Fn::Sub: ${ProjectPrefix}-ci-worker-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: codebuild.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: Logs
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource: '*'
      - PolicyName: CodeCommitRead
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - codecommit:GitPull
            - codecommit:GetRepository
            - codecommit:GetBranch
            - codecommit:GetCommit
            Resource:
              Fn::Sub: arn:${AWS::Partition}:codecommit:${AWS::Region}:${AWS::AccountId}:${RepoName}
  CiDispatchProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name:
        Fn::Sub: ${ProjectPrefix}-ci-dispatch
      ServiceRole:
        Fn::GetAtt:
        - CiDispatchRole
        - Arn
      Artifacts:
        Type: NO_ARTIFACTS
      Source:
        Type: CODECOMMIT
        Location:
          Fn::Sub: https://git-codecommit.${AWS::Region}.amazonaws.com/v1/repos/${RepoName}
        GitCloneDepth: 1
        BuildSpec: pipeline/ci-dispatcher.yml
      Environment:
        Type: LINUX_CONTAINER
        Image:
          Fn::FindInMap:
          - Images
          - Standard
          - Image
        ComputeType: BUILD_GENERAL1_SMALL
        EnvironmentVariables:
        - Name: REPO_NAME
          Value:
            Ref: RepoName
        - Name: BRANCH
          Value:
            Ref: BranchName
        - Name: CI_ENV
          Value:
            Ref: CiEnv
        - Name: CI_DDB
          Value:
            Ref: CiDdbLayerProject
        - Name: CI_FUNC
          Value:
            Ref: CiFunctionWorkerProject
      TimeoutInMinutes: 10
      QueuedTimeoutInMinutes: 10
      LogsConfig:
        CloudWatchLogs:
          Status: ENABLED
  CiDdbLayerProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name:
        Fn::Sub: ${ProjectPrefix}-ci-layers-ddb
      ServiceRole:
        Fn::GetAtt:
        - CiWorkerRole
        - Arn
      Artifacts:
        Type: NO_ARTIFACTS
      Source:
        Type: CODECOMMIT
        Location:
          Fn::Sub: https://git-codecommit.${AWS::Region}.amazonaws.com/v1/repos/${RepoName}
        GitCloneDepth: 1
        BuildSpec: pipeline/ci-worker.yml
      Environment:
        Type: LINUX_CONTAINER
        Image:
          Fn::FindInMap:
          - Images
          - Standard
          - Image
        ComputeType: BUILD_GENERAL1_SMALL
        EnvironmentVariables:
        - Name: ENV
          Value:
            Ref: CiEnv
        - Name: MAKE_TARGET
          Value: ci-ddb-layer
      LogsConfig:
        CloudWatchLogs:
          Status: ENABLED
  CiFunctionWorkerProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name:
        Fn::Sub: ${ProjectPrefix}-ci-functions-generic
      ServiceRole:
        Fn::GetAtt:
        - CiWorkerRole
        - Arn
      Artifacts:
        Type: NO_ARTIFACTS
      Source:
        Type: CODECOMMIT
        Location:
          Fn::Sub: https://git-codecommit.${AWS::Region}.amazonaws.com/v1/repos/${RepoName}
        GitCloneDepth: 1
        BuildSpec: pipeline/ci-worker.yml
      Environment:
        Type: LINUX_CONTAINER
        Image:
          Fn::FindInMap:
          - Images
          - Standard
          - Image
        ComputeType: BUILD_GENERAL1_SMALL
        EnvironmentVariables:
        - Name: ENV
          Value:
            Ref: CiEnv
        - Name: MAKE_TARGET
          Value: ci-function
      LogsConfig:
        CloudWatchLogs:
          Status: ENABLED
  PullRequestCI:
    Type: AWS::Events::Rule
    Properties:
      Name:
        Fn::Sub: ${ProjectPrefix}-ci-pr
      Description:
        Fn::Sub: Trigger CI on CodeCommit PR create/update to ${BranchName}
      EventPattern:
        source:
        - aws.codecommit
        detail-type:
        - CodeCommit Pull Request State Change
        resources:
        - Fn::Sub: arn:${AWS::Partition}:codecommit:${AWS::Region}:${AWS::AccountId}:${RepoName}
        detail:
          event:
          - pullRequestCreated
          - pullRequestSourceBranchUpdated
          - pullRequestReopened
          destinationReference:
          - Fn::Sub: refs/heads/${BranchName}
      Targets:
      - Id: Dispatch
        Arn:
          Fn::GetAtt:
          - CiDispatchProject
          - Arn
        RoleArn:
          Fn::GetAtt:
          - EventsToCodeBuildRole
          - Arn
        InputTransformer:
          InputPathsMap:
            pr: $.detail.pullRequestId
            srcCommit: $.detail.sourceCommit
            dstCommit: $.detail.destinationCommit
          InputTemplate: "{\n  \"sourceVersion\": \"<dstCommit>\",\n  \"environmentVariablesOverride\"\
            : [\n    {\"name\":\"PR_ID\",\"value\":\"<pr>\",\"type\":\"PLAINTEXT\"\
            },\n    {\"name\":\"SOURCE_COMMIT\",\"value\":\"<srcCommit>\",\"type\"\
            :\"PLAINTEXT\"},\n    {\"name\":\"DESTINATION_COMMIT\",\"value\":\"<dstCommit>\"\
            ,\"type\":\"PLAINTEXT\"}\n  ]\n}\n"
  CiDeployerRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName:
        Fn::Sub: ${ProjectPrefix}-ci-deployer-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: codebuild.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: Logs
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource: '*'
      - PolicyName: CodeCommitRead
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - codecommit:GitPull
            - codecommit:GetRepository
            - codecommit:GetCommit
            - codecommit:GetDifferences
            Resource:
              Fn::Sub: arn:${AWS::Partition}:codecommit:${AWS::Region}:${AWS::AccountId}:${RepoName}
      - PolicyName: CloudFormationDeploy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - cloudformation:CreateChangeSet
            - cloudformation:ExecuteChangeSet
            - cloudformation:CreateStack
            - cloudformation:UpdateStack
            - cloudformation:Describe*
            Resource:
              Fn::Sub: arn:${AWS::Partition}:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/${ProjectPrefix}-*/*
      - PolicyName: SamArtifactsS3
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - s3:PutObject
            - s3:GetObject
            - s3:ListBucket
            Resource: '*'
CiDeployerProject:
  Type: AWS::CodeBuild::Project
  Properties:
    Name:
      Fn::Sub: ${ProjectPrefix}-ci-deploy
    ServiceRole:
      Fn::GetAtt:
      - CiDeployerRole
      - Arn
    Artifacts:
      Type: NO_ARTIFACTS
    Source:
      Type: CODECOMMIT
      Location:
        Fn::Sub: https://git-codecommit.${AWS::Region}.amazonaws.com/v1/repos/${RepoName}
      GitCloneDepth: 1
      BuildSpec: pipeline/ci-deploy.yml
    Environment:
      Type: LINUX_CONTAINER
      Image:
        Fn::FindInMap:
        - Images
        - Standard
        - Image
      ComputeType: BUILD_GENERAL1_SMALL
    TimeoutInMinutes: 20
    LogsConfig:
      CloudWatchLogs:
        Status: ENABLED
  MainBranchCD:
    Type: AWS::Events::Rule
    Properties:
      Name:
        Fn::Sub: ${ProjectPrefix}-cd-main
      Description: Auto-deploy on merge to main
      EventPattern:
        source:
        - aws.codecommit
        detail-type:
        - CodeCommit Repository State Change
        resources:
        - Fn::Sub: arn:${AWS::Partition}:codecommit:${AWS::Region}:${AWS::AccountId}:${RepoName}
        detail:
          event:
          - referenceUpdated
          referenceFullName:
          - refs/heads/${BranchName}
      Targets:
      - Id: Deployer
        Arn:
          Fn::GetAtt:
          - CiDeployerProject
          - Arn
        RoleArn:
          Fn::GetAtt:
          - EventsToCodeBuildRole
          - Arn
        InputTransformer:
          InputPathsMap:
            commit: $.detail.commitId
            old: $.detail.oldCommitId
            ref: $.detail.referenceFullName
          InputTemplate: "{\n  \"environmentVariablesOverride\": [\n    {\"name\"\
            :\"COMMIT_ID\",\"value\":\"<commit>\",\"type\":\"PLAINTEXT\"},\n    {\"\
            name\":\"OLD_COMMIT\",\"value\":\"<old>\",\"type\":\"PLAINTEXT\"},\n \
            \   {\"name\":\"REF\",\"value\":\"<ref>\",\"type\":\"PLAINTEXT\"},\n \
            \   {\"name\":\"ENV\",\"value\":\"${CiEnv}\",\"type\":\"PLAINTEXT\"},\n\
            \    {\"name\":\"REPO_NAME\",\"value\":\"${RepoName}\",\"type\":\"PLAINTEXT\"\
            },\n    {\"name\":\"PROJECT_PREFIX\",\"value\":\"${ProjectPrefix}\",\"\
            type\":\"PLAINTEXT\"}\n  ]\n}\n"
Outputs:
  DispatchProject:
    Value:
      Ref: CiDispatchProject
  WorkerDdb:
    Value:
      Ref: CiDdbLayerProject
  WorkerFunction:
    Value:
      Ref: CiFunctionWorkerProject
